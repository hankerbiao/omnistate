# 业务流程文档

本文档描述了当前工作流系统的核心业务逻辑、状态机设计以及流转规则。本系统采用了**配置驱动（Configuration-Driven）**的架构，所有业务流程均通过 JSON 配置文件定义，无需修改代码即可扩展。

## 1. 架构概览

系统基于通用状态机引擎构建，核心特点如下：
- **解耦设计**：状态（State）和动作（Action）不再硬编码在代码中，而是作为纯字符串由配置文件定义。
- **配置驱动**：业务类型、状态迁移规则、负责人策略以及表单校验规则均在 [workflow_initial_data.json](file:///Users/libiao/Desktop/github/test/configs/workflow_initial_data.json) 中统一定义。
- **自动审计**：每一次状态流转都会自动记录详细的审计日志（BusFlowLog）。

---

## 2. 核心业务流程

目前系统支持以下两种核心业务流程：

### 2.1 需求流程 (REQUIREMENT)
用于管理产品需求的生命周期。

| 当前状态 | 触发动作 | 目标状态 | 负责人策略 | 必填字段 |
| :--- | :--- | :--- | :--- | :--- |
| **DRAFT** (草稿) | `SUBMIT` | **PENDING_AUDIT** | 指派给特定用户 | `priority`, `target_owner_id` |
| **PENDING_AUDIT** (待审核) | `APPROVE` | **DONE** | 保持当前负责人 | `comment` |
| **PENDING_AUDIT** (待审核) | `REJECT` | **DRAFT** | 退回给创建者 | `comment` |

### 2.2 测试用例流程 (TEST_CASE)
用于管理测试用例的编写、指派、开发和审核。

| 当前状态 | 触发动作 | 目标状态 | 负责人策略 | 必填字段 |
| :--- | :--- | :--- | :--- | :--- |
| **DRAFT** (草稿) | `ASSIGN` | **ASSIGNED** | 指派给特定用户 | `target_owner_id` |
| **ASSIGNED** (已指派) | `START_DEVELOP` | **DEVELOPING** | 保持当前负责人 | - |
| **DEVELOPING** (开发中) | `FINISH_DEVELOP` | **PENDING_REVIEW** | 指派给特定评审人 | `target_owner_id` |
| **PENDING_REVIEW** (待评审) | `APPROVE` | **DONE** | 保持当前负责人 | `comment` |
| **PENDING_REVIEW** (待评审) | `REJECT` | **DEVELOPING** | 退回给开发者 | `comment` |

---

## 3. 关键机制说明

### 3.1 负责人处理策略 (Owner Strategy)
在状态流转时，系统支持多种负责人分配策略：
- `KEEP`: 负责人保持不变。
- `TO_CREATOR`: 负责人变更为事项的最初创建者。
- `TO_SPECIFIC_USER`: 从表单数据（`form_data`）中的 `target_owner_id` 字段获取新的负责人。

### 3.2 必填字段校验 (Field Validation)
配置文件中的 `required_fields` 定义了执行特定动作时必须提供的表单数据。如果缺失，流转将失败并报错。

---

## 4. 如何扩展新流程

若需增加新的业务流程（如“缺陷管理”），请遵循以下步骤：

1. **修改配置文件**：在 [workflow_initial_data.json](file:///Users/libiao/Desktop/github/test/configs/workflow_initial_data.json) 中：
   - 在 `work_types` 下增加新类型（如 `BUG`）。
   - 在 `workflow_configs` 下定义该类型的每一条状态迁移规则。
2. **重新初始化**：重启应用或调用 `init_mock_config` 方法，系统将自动加载并生效新配置。
3. **编写测试**：参考 [test_complex_workflows.py](file:///Users/libiao/Desktop/github/test/test_complex_workflows.py) 编写新流程的验证脚本。
